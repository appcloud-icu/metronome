<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse | Precision Visual Metronome</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Default: Cyberpunk */
            --bg-main: #0f172a; /* Slate 900 */
            --bg-panel: rgba(30, 41, 59, 0.7); /* Slate 800 */
            --text-main: #e2e8f0; /* Slate 200 */
            --text-dim: #94a3b8; /* Slate 400 */
            
            --color-beat: #22d3ee; /* Cyan 400 */
            --color-beat-glow: rgba(34, 211, 238, 0.6);
            --color-accent: #f472b6; /* Pink 400 */
            --color-accent-glow: rgba(244, 114, 182, 0.9);
            
            --flash-beat: #0c2d3a;
            --flash-accent: #4a0420;
            
            --orb-bg: #1e293b;
            --orb-border: #334155;
        }

        /* Zen Theme (Light) */
        [data-theme="zen"] {
            --bg-main: #f8fafc; /* Slate 50 */
            --bg-panel: rgba(255, 255, 255, 0.85);
            --text-main: #334155; /* Slate 700 */
            --text-dim: #64748b; /* Slate 500 */
            
            --color-beat: #0ea5e9; /* Sky 500 */
            --color-beat-glow: rgba(14, 165, 233, 0.5);
            --color-accent: #f59e0b; /* Amber 500 */
            --color-accent-glow: rgba(245, 158, 11, 0.6);
            
            --flash-beat: #e0f2fe;
            --flash-accent: #fef3c7;
            
            --orb-bg: #ffffff;
            --orb-border: #cbd5e1;
        }

        /* Vampire Theme */
        [data-theme="vampire"] {
            --bg-main: #000000;
            --bg-panel: rgba(20, 0, 0, 0.8);
            --text-main: #e5e5e5;
            --text-dim: #a17f7f;
            
            --color-beat: #ef4444; /* Red 500 */
            --color-beat-glow: rgba(239, 68, 68, 0.6);
            --color-accent: #7f1d1d; /* Red 900 (Visual inversion for style) */ 
            --color-accent-glow: rgba(255, 0, 0, 0.8); /* Pure Red */
            
            --flash-beat: #1a0505;
            --flash-accent: #380404;
            
            --orb-bg: #110000;
            --orb-border: #450a0a;
        }

        /* Forest Theme */
        [data-theme="forest"] {
            --bg-main: #052e16; /* Green 950 */
            --bg-panel: rgba(20, 83, 45, 0.7);
            --text-main: #ecfccb; /* Lime 100 */
            --text-dim: #86efac; /* Green 300 */
            
            --color-beat: #4ade80; /* Green 400 */
            --color-beat-glow: rgba(74, 222, 128, 0.6);
            --color-accent: #facc15; /* Yellow 400 */
            --color-accent-glow: rgba(250, 204, 21, 0.8);
            
            --flash-beat: #064e3b;
            --flash-accent: #3f3608;
            
            --orb-bg: #064e3b;
            --orb-border: #14532d;
        }

        /* --- BASE STYLES --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .mono-font {
            font-family: 'JetBrains Mono', monospace;
        }

        .text-dim { color: var(--text-dim); }
        .text-main { color: var(--text-main); }
        .text-beat { color: var(--color-beat); }
        .border-dim { border-color: var(--orb-border); }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--color-beat);
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 0 10px var(--color-beat-glow);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: var(--orb-border);
            border-radius: 2px;
        }

        /* Number Input Styling */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
            color: var(--text-main);
            border-bottom: 2px solid transparent;
        }
        input[type=number]:hover {
            border-color: var(--orb-border);
        }
        input[type=number]:focus {
            border-color: var(--color-beat);
        }

        /* Visual Pulse Animation */
        .pulse-circle {
            background-color: var(--orb-bg);
            border-color: var(--orb-border);
            transition: transform 0.1s cubic-bezier(0.1, 0, 0.2, 1), box-shadow 0.1s, background-color 0.1s, border-color 0.3s;
        }

        .beat-active {
            transform: scale(1.2);
            background-color: var(--color-beat);
            box-shadow: 0 0 60px var(--color-beat), 0 0 120px var(--color-beat-glow);
            border-color: var(--color-beat);
            color: var(--bg-main); /* Invert text color on beat */
        }

        .beat-accent {
            transform: scale(1.45);
            background-color: var(--color-accent);
            box-shadow: 0 0 100px var(--color-accent), 0 0 180px var(--color-accent-glow);
            border-color: var(--color-accent);
            color: var(--bg-main); /* Invert text color on beat */
        }

        /* Full Screen Flash */
        .flash-screen-accent { animation: flash-accent-anim 0.2s ease-out; }
        .flash-screen-normal { animation: flash-normal-anim 0.15s ease-out; }

        @keyframes flash-accent-anim {
            0% { background-color: var(--flash-accent); }
            100% { background-color: var(--bg-main); }
        }

        @keyframes flash-normal-anim {
            0% { background-color: var(--flash-beat); }
            100% { background-color: var(--bg-main); }
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            opacity: 1;
            pointer-events: none;
            border-width: 4px;
            animation: ripple-anim 0.6s linear;
        }
        
        .ripple-normal { border-color: var(--color-beat); }
        .ripple-accent { border-color: var(--color-accent); }

        @keyframes ripple-anim {
            to {
                transform: scale(5);
                opacity: 0;
            }
        }

        /* Panel Styling */
        .control-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Dropdown Styling */
        select {
            background-color: var(--orb-bg);
            color: var(--text-main);
            border: 1px solid var(--orb-border);
        }
        select:focus {
            outline: none;
            border-color: var(--color-beat);
        }

        /* Buttons */
        .btn-icon {
            background-color: var(--orb-bg);
            color: var(--text-dim);
        }
        .btn-icon:hover {
            color: var(--text-main);
            background-color: var(--orb-border);
        }
        
        .btn-play {
            background-color: var(--color-beat);
            color: var(--bg-main);
            box-shadow: 0 10px 15px -3px var(--color-beat-glow);
        }
        .btn-play.playing {
            background-color: var(--color-accent);
            box-shadow: 0 10px 15px -3px var(--color-accent-glow);
        }
        .btn-play:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
        }

        .tap-btn {
            border: 1px solid var(--orb-border);
            color: var(--text-dim);
        }
        .tap-btn:hover {
            border-color: var(--color-beat);
            color: var(--color-beat);
        }
        .tap-btn.active {
            border-color: var(--color-beat);
            color: var(--color-beat);
            background-color: var(--flash-beat);
        }

    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-between" data-theme="cyberpunk">

    <!-- Top Info -->
    <div class="w-full p-6 flex justify-between items-center z-10">
        <div class="flex items-center gap-2 text-beat">
            <i class="fa-solid fa-wave-square"></i>
            <span class="font-bold tracking-wider">PULSE</span>
        </div>
        <div class="text-xs text-dim font-mono">AUDIO ENGINE: READY</div>
    </div>

    <!-- Main Visual Area -->
    <div class="flex-grow flex flex-col items-center justify-center w-full relative">
        <div class="relative flex items-center justify-center">
            <!-- Ripple Container -->
            <div id="ripple-container" class="absolute inset-0 flex items-center justify-center"></div>
            
            <!-- Main Orb -->
            <div id="visual-beat" class="w-32 h-32 md:w-48 md:h-48 rounded-full border-4 pulse-circle flex items-center justify-center z-10 shadow-2xl">
                <div class="text-center pointer-events-none select-none">
                    <div id="beat-counter" class="text-4xl md:text-6xl font-bold mono-font">1</div>
                    <div class="text-xs mt-1 uppercase tracking-widest opacity-70">Beat</div>
                </div>
            </div>
            
            <!-- Orbit Ring (Decorative) -->
            <div class="absolute w-48 h-48 md:w-72 md:h-72 border border-dim rounded-full animate-[spin_10s_linear_infinite] opacity-50">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-slate-500 rounded-full"></div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel w-full p-6 pb-10 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.3)] z-20 transition-all duration-300">
        <div class="max-w-2xl mx-auto space-y-6">
            
            <!-- Play/Stop & BPM Display -->
            <div class="flex items-center justify-between">
                <button id="play-btn" class="w-16 h-16 rounded-full btn-play flex items-center justify-center text-2xl transition-all active:scale-95">
                    <i class="fa-solid fa-play ml-1"></i>
                </button>

                <div class="flex flex-col items-end">
                    <div class="flex items-baseline gap-1">
                        <input type="number" id="bpm-input" value="120" min="30" max="250" 
                               class="text-5xl font-bold mono-font bg-transparent outline-none w-36 text-right transition-colors p-0 cursor-text">
                        <span class="text-sm text-beat font-bold">BPM</span>
                    </div>
                    <button id="tap-btn" class="text-xs tap-btn px-3 py-1 rounded transition-colors uppercase tracking-wider mt-1">
                        TAP TEMPO
                    </button>
                </div>
            </div>

            <!-- Controls Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Speed Control -->
                <div class="space-y-2">
                    <div class="flex justify-between text-sm text-dim">
                        <span>Tempo</span>
                        <span class="text-xs bg-transparent border border-dim px-2 py-0.5 rounded opacity-50">- / +</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="bpm-minus" class="w-8 h-8 rounded-full btn-icon flex items-center justify-center transition-colors">
                            <i class="fa-solid fa-minus text-xs"></i>
                        </button>
                        <input type="range" id="bpm-slider" min="30" max="250" value="120" class="w-full">
                        <button id="bpm-plus" class="w-8 h-8 rounded-full btn-icon flex items-center justify-center transition-colors">
                            <i class="fa-solid fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>

                <!-- Bottom Row: Volume, Sig, Theme -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Volume -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm text-dim">
                            <span>Volume</span>
                            <button id="mute-btn" class="text-dim hover:text-main transition-colors">
                                <i class="fa-solid fa-volume-high" id="mute-icon"></i>
                            </button>
                        </div>
                        <input type="range" id="volume-slider" min="0" max="100" value="80" class="w-full">
                    </div>

                    <!-- Configs -->
                    <div class="space-y-2">
                        <div class="flex justify-between gap-2">
                            <div class="w-1/2">
                                <label class="text-xs text-dim block mb-1">Time Sig</label>
                                <select id="signature-select" class="w-full text-sm rounded px-2 py-1 cursor-pointer">
                                    <option value="1">1/4</option>
                                    <option value="2">2/4</option>
                                    <option value="3">3/4</option>
                                    <option value="4" selected>4/4</option>
                                    <option value="5">5/4</option>
                                    <option value="6">6/8</option>
                                    <option value="7">7/8</option>
                                </select>
                            </div>
                            <div class="w-1/2">
                                <label class="text-xs text-dim block mb-1">Theme</label>
                                <select id="theme-select" class="w-full text-sm rounded px-2 py-1 cursor-pointer">
                                    <option value="cyberpunk">Cyber</option>
                                    <option value="zen">Zen</option>
                                    <option value="vampire">Vampire</option>
                                    <option value="forest">Forest</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        let audioContext = null;
        let isPlaying = false;
        let bpm = 120;
        let beatsPerMeasure = 4;
        let currentBeat = 0;
        let nextNoteTime = 0.0;
        let timerID = null;
        let lookahead = 25.0; 
        let scheduleAheadTime = 0.1;
        let volume = 0.8;
        let isMuted = false;
        let tapTimes = [];
        const TAP_TIMEOUT = 2000;
        const notesInQueue = []; 

        // --- DOM Elements ---
        const playBtn = document.getElementById('play-btn');
        const playIcon = playBtn.querySelector('i');
        const visualBeat = document.getElementById('visual-beat');
        const beatCounter = document.getElementById('beat-counter');
        const rippleContainer = document.getElementById('ripple-container');
        const bpmSlider = document.getElementById('bpm-slider');
        const bpmInput = document.getElementById('bpm-input');
        const bpmMinus = document.getElementById('bpm-minus');
        const bpmPlus = document.getElementById('bpm-plus');
        const volumeSlider = document.getElementById('volume-slider');
        const muteBtn = document.getElementById('mute-btn');
        const muteIcon = document.getElementById('mute-icon');
        const signatureSelect = document.getElementById('signature-select');
        const themeSelect = document.getElementById('theme-select');
        const tapBtn = document.getElementById('tap-btn');

        // --- Audio Engine ---
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function nextNote() {
            const secondsPerBeat = 60.0 / bpm;
            nextNoteTime += secondsPerBeat;
            currentBeat++;
            if (currentBeat >= beatsPerMeasure) {
                currentBeat = 0;
            }
        }

        function scheduleNote(beatNumber, time) {
            notesInQueue.push({ noteBeat: beatNumber, time: time });

            if (isMuted) return;

            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (beatNumber === 0) {
                osc.frequency.value = 1000;
            } else {
                osc.frequency.value = 600;
            }

            gainNode.gain.setValueAtTime(volume, time);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.05);

            osc.start(time);
            osc.stop(time + 0.05);
        }

        function scheduler() {
            while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
                scheduleNote(currentBeat, nextNoteTime);
                nextNote();
            }
        }

        // --- Visual Engine ---
        function draw() {
            const drawNote = function() {
                const currentTime = audioContext.currentTime;

                while (notesInQueue.length && notesInQueue[0].time < currentTime) {
                    const currentNote = notesInQueue[0];
                    triggerVisual(currentNote.noteBeat);
                    notesInQueue.shift();
                }

                if (isPlaying) {
                    requestAnimationFrame(drawNote);
                }
            };
            requestAnimationFrame(drawNote);
        }

        function triggerVisual(beatNumber) {
            beatCounter.innerText = beatNumber + 1;

            const isAccent = beatNumber === 0;
            const activeClass = isAccent ? 'beat-accent' : 'beat-active';
            const rippleClass = isAccent ? 'ripple-accent' : 'ripple-normal';

            // Flash Logic
            if (isAccent) {
                document.body.classList.remove('flash-screen-normal', 'flash-screen-accent');
                void document.body.offsetWidth; 
                document.body.classList.add('flash-screen-accent');
            } else {
                document.body.classList.remove('flash-screen-accent', 'flash-screen-normal');
                void document.body.offsetWidth; 
                document.body.classList.add('flash-screen-normal');
            }

            // Pulse Logic
            // We use JS to add classes that trigger CSS changes using variables
            visualBeat.classList.add(activeClass);

            // Ripple Logic
            const ripple = document.createElement('div');
            ripple.className = `ripple w-32 h-32 md:w-48 md:h-48 ${rippleClass}`;
            rippleContainer.appendChild(ripple);

            setTimeout(() => {
                visualBeat.classList.remove('beat-active', 'beat-accent');
            }, 100);

            setTimeout(() => {
                ripple.remove();
            }, 600);
            
            setTimeout(() => {
                document.body.classList.remove('flash-screen-accent', 'flash-screen-normal');
            }, 200);
        }


        // --- UI Interactions ---

        function togglePlay() {
            initAudioContext();
            isPlaying = !isPlaying;

            if (isPlaying) {
                currentBeat = 0;
                nextNoteTime = audioContext.currentTime + 0.05;
                timerID = setInterval(scheduler, lookahead);
                draw();
                
                playBtn.classList.add('playing');
                playIcon.classList.remove('fa-play');
                playIcon.classList.add('fa-stop');
            } else {
                clearInterval(timerID);
                playBtn.classList.remove('playing');
                playIcon.classList.add('fa-play');
                playIcon.classList.remove('fa-stop');
                visualBeat.classList.remove('beat-active', 'beat-accent');
            }
        }

        function updateBPM(val) {
            let newBpm = parseInt(val);
            if (isNaN(newBpm)) return;
            if(newBpm < 30) newBpm = 30;
            if(newBpm > 250) newBpm = 250;
            bpm = newBpm;
            bpmSlider.value = bpm;
            if (document.activeElement !== bpmInput) {
                bpmInput.value = bpm;
            }
        }

        bpmSlider.addEventListener('input', (e) => {
            bpmInput.value = e.target.value;
            updateBPM(e.target.value);
        });

        bpmInput.addEventListener('change', (e) => {
            updateBPM(e.target.value);
            bpmInput.value = bpm;
            bpmInput.blur();
        });
        
        bpmInput.addEventListener('keydown', (e) => {
             if(e.key === 'Enter') bpmInput.blur();
        });
        
        bpmMinus.addEventListener('click', () => {
             updateBPM(bpm - 1);
             bpmInput.value = bpm;
        });
        bpmPlus.addEventListener('click', () => {
             updateBPM(bpm + 1);
             bpmInput.value = bpm;
        });

        volumeSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            volume = val / 100;
            if (volume > 0 && isMuted) toggleMute();
            if (volume === 0 && !isMuted) toggleMute();
        });

        function toggleMute() {
            isMuted = !isMuted;
            if (isMuted) {
                muteIcon.classList.remove('fa-volume-high');
                muteIcon.classList.add('fa-volume-xmark');
                muteBtn.style.color = 'var(--color-beat)'; // Indicate mute
            } else {
                muteIcon.classList.add('fa-volume-high');
                muteIcon.classList.remove('fa-volume-xmark');
                muteBtn.style.color = '';
                if(volume === 0) {
                    volume = 0.5;
                    volumeSlider.value = 50;
                }
            }
        }
        muteBtn.addEventListener('click', toggleMute);

        signatureSelect.addEventListener('change', (e) => {
            beatsPerMeasure = parseInt(e.target.value);
            currentBeat = 0;
        });

        // Theme Switcher
        themeSelect.addEventListener('change', (e) => {
            document.body.setAttribute('data-theme', e.target.value);
        });

        tapBtn.addEventListener('click', () => {
            const now = Date.now();
            if (tapTimes.length > 0 && now - tapTimes[tapTimes.length - 1] > TAP_TIMEOUT) {
                tapTimes = [];
            }
            tapTimes.push(now);
            if (tapTimes.length > 4) tapTimes.shift();

            if (tapTimes.length > 1) {
                let intervals = [];
                for (let i = 1; i < tapTimes.length; i++) {
                    intervals.push(tapTimes[i] - tapTimes[i-1]);
                }
                const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                const newBpm = Math.round(60000 / avgInterval);
                updateBPM(newBpm);
                bpmInput.value = bpm;
            }

            tapBtn.classList.add('active');
            setTimeout(() => tapBtn.classList.remove('active'), 100);
        });

        playBtn.addEventListener('click', togglePlay);
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && document.activeElement !== bpmInput) {
                e.preventDefault();
                togglePlay();
            }
        });
    </script>
</body>
</html>
